@page "/generate"

@attribute [Authorize]

<PageTitle>Your AI-powered career assistant</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4 d-print-none">🆕 Generate Application</MudText>

    <MudGrid>
        <MudItem xs="12" Class="d-print-none">
            <div class="d-print-none">
                <MudCard Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-1">📋 Job Details</MudText>
                    <MudForm @ref="_form">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudSelect T="AIModel" Label="Model" @bind-Value="_selectedModel" Variant="Variant.Outlined" Clearable="true" HelperText="Select the AI model" Disabled="_isLoadingModels">
                                @if (_isLoadingModels)
                                {
                                    <MudSelectItem Value="AIModel.Gpt4o">Loading models...</MudSelectItem>
                                }
                                else
                                {
                                    @foreach (var model in _availableModels)
                                    {
                                        <MudSelectItem Value="@model">@GetModelDisplayName(model)</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                            <MudTextField @bind-Value="_job.CompanyName" Label="Company Name" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Business" Clearable="true" HelperText="Will be Auto-detected and updated by AI" />
                            <MudTextField @bind-Value="_job.Title" Label="Job Title" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Work" Clearable="true" HelperText="Will be Auto-detected and updated by AI" />
                            <MudSwitch @bind-Value="_manualEntry" Color="Color.Primary" Class="mb-6" Label="Manual Entry Mode" T="bool" />
                        </MudStack>

                        @if (!_manualEntry)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3" Spacing="2">
                                <!-- Text Field takes all available space -->
                                <MudItem Class="flex-grow-1">
                                    <MudTextField @bind-Value="_job.Url"
                                                  Label="Job URL"
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Link"
                                                  Required="true"
                                                  RequiredError=""
                                                  Clearable="true" />
                                </MudItem>

                                <!-- Button stays at the end -->
                                <MudItem Class="d-flex justify-end">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Secondary"
                                               Size="Size.Large"
                                               OnClick="FetchJobDetails"
                                               Disabled="_isFetching"
                                               StartIcon="@Icons.Material.Filled.CloudDownload">
                                        @if (_isFetching)
                                        {
                                            <WebCV.Web.Components.Shared.LoadingIndicator />
                                        }
                                        else
                                        {
                                            <MudText>Fetch</MudText>
                                        }
                                    </MudButton>
                                </MudItem>
                            </MudStack>
                        }

                        @if (_showAdvancedEditor || _manualEntry)
                        {
                            int _min = 10;
                            int _max = 90;

                            <div class="d-flex flex-grow-1" style="height: 600px; width: 100%;">
                                <MudPaper Width="@($"{_splitterSize}%")" Class="d-flex flex-column" Style="height: 100%;" Elevation="0">
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.caption">Editor (Markdown) | Job Description</MudText>
                                        <MudTooltip Text="Clear Content">
                                            <MudIconButton Icon="@Icons.Material.Filled.DeleteSweep" Size="Size.Small" Color="Color.Error" OnClick="ClearEditor" />
                                        </MudTooltip>
                                    </div>
                                    <div class="flex-grow-1" style="overflow-y: auto;">
                                        <MudTextField @bind-Value="_job.Description"
                                                      Variant="Variant.Outlined"
                                                      Required="true"
                                                      RequiredError=""
                                                      AutoGrow="true"
                                                      Class="flex-grow-1"
                                                      Style="min-height: 100%;"
                                                      Immediate="true"
                                                      DebounceInterval="300"
                                                      TextChanged="UpdatePreview" />
                                    </div>
                                </MudPaper>

                                <MudPaper Width="@($"{100 - _splitterSize}%")" Class="d-flex flex-column pl-1" Style="height: 100%;" Elevation="0">
                                    <MudText Typo="Typo.caption" Class="mb-1">Preview (HTML)</MudText>
                                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 flex-grow-1" Style="overflow-y: auto; background-color: var(--mud-palette-background-grey);">
                                        @if (string.IsNullOrWhiteSpace(_previewHtml))
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">Preview will appear here...</MudText>
                                        }
                                        else
                                        {
                                            <div class="markdown-body">
                                                @((MarkupString)_previewHtml)
                                            </div>
                                        }
                                    </MudPaper>
                                </MudPaper>
                            </div>

                            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-2"
                                      Style="border:1px solid lightgrey; border-radius:4px; padding:4px;">

                                <!-- LEFT AREA: centered content -->
                                <div style="flex:1; display:flex; align-items:center; justify-content:center;">
                                    <MudText Typo="Typo.caption" Class="mr-2">Split Ratio: <strong>@_splitterSize</strong> (min:@_min | max:@_max)</MudText>
                                    <MudSlider T="int" @bind-Value="@_splitterSize"
                                               Min="_min"
                                               Max="_max"
                                               Step="1"
                                               Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               ValueLabel="true"
                                               Style="width:400px;" />
                                </div>

                                <!-- CENTER DIVIDER -->
                                <MudDivider Vertical="true"
                                            FlexItem="true"
                                            Class="mx-3" />

                                <!-- RIGHT AREA: centered content -->
                                <div style="flex:1; display:flex; align-items:center; justify-content:center;">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               Size="Size.Medium"
                                               OnClick="GenerateContent"
                                               Disabled="_isGenerating"
                                               StartIcon="@Icons.Material.Filled.AutoAwesome"
                                               Style="min-width:200px;">
                                        @if (_isGenerating)
                                        {
                                            <WebCV.Web.Components.Shared.LoadingIndicator />
                                            <MudText Class="ms-2">Generating...</MudText>
                                        }
                                        else
                                        {
                                            <MudText>Generate Application</MudText>
                                        }
                                    </MudButton>
                                </div>
                            </MudStack>
                        }
                    </MudForm>
                </MudCard>
            </div>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="3" Class="pa-2" Style="height: 100%;">
                <MudToolBar Class="d-print-none">
                    <MudText Class="mb-1" Typo="Typo.h6">✨ Generated Content</MudText>
                    <MudSpacer />
                    <MudSwitch @bind-Value="_previewCoverLetter" Color="Color.Primary" Label="Visual Preview" Class="mr-4" Style="@GetDisplayStyle(_activeTabIndex == 0)" />
                    <MudSwitch T="bool" Value="_previewResume" ValueChanged="OnResumePreviewToggled" Color="Color.Primary" Label="Visual Preview" Class="mr-4" Style="@GetDisplayStyle(_activeTabIndex == 1)" />
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="@(() => CopyToClipboard(_generatedCoverLetter))" Class="mr-2" Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">Copy Text</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Print" OnClick="PrintCoverLetter" Class="mr-2" Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">Print</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveApplication" Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">Save Application</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="CopyResumeJson" Class="mr-2" Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">Copy JSON Data</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Print" OnClick="PrintResume" Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">Print CV</MudButton>
                </MudToolBar>
                <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-2" KeepPanelsAlive="false" @bind-ActivePanelIndex="_activeTabIndex">
                    <MudTabPanel Text="Cover Letter" Icon="@Icons.Material.Filled.Description">
                        @if (string.IsNullOrEmpty(_generatedCoverLetter))
                        {
                            <MudAlert Severity="Severity.Info">Enter job details and click Generate to create a cover letter.</MudAlert>
                        }
                        else
                        {
                            @if (_previewCoverLetter)
                            {
                                <MudPaper Elevation="0" Class="cv-paper-container d-print-block" Style="overflow-y: auto; max-height: calc(100vh - 250px);">
                                    <WebCV.Web.Components.Shared.CoverLetterPreview Profile="_cachedProfile" LetterContent="@_generatedCoverLetter" />
                                </MudPaper>
                            }
                            else
                            {
                                <MudTextField @bind-Value="_generatedCoverLetter" Variant="Variant.Outlined" Lines="25" Class="mb-2 d-print-none" />
                            }
                        }
                    </MudTabPanel>
                    <MudTabPanel Text="Tailored CV" Icon="@Icons.Material.Filled.ContactPage">
                        @if (_generatedResume == null)
                        {
                            <MudAlert Severity="Severity.Info">Enter job details and click Generate to create a tailored CV.</MudAlert>
                        }
                        else
                        {
                            @if (_previewResume)
                            {
                                <MudPaper Elevation="0" Class="cv-paper-container d-print-block" Style="overflow-y: auto; max-height: calc(100vh - 250px);">
                                    <WebCV.Web.Components.Shared.CvPreview Profile="_generatedResume" />
                                </MudPaper>
                            }
                            else
                            {
                                <MudStack Row="true" Class="mb-2" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.caption" Color="Color.Warning"><strong>Warning:</strong> You are editing the raw data structure. Syntax errors will prevent the CV from rendering.</MudText>
                                    <MudSpacer />
                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Error" StartIcon="@Icons.Material.Filled.Restore" OnClick="ResetResumeJson">Reset Changes</MudButton>
                                </MudStack>
                                <MudTextField @bind-Value="_resumeJson" Label="Edit Resume JSON" Variant="Variant.Outlined" Lines="25" Class="mb-2 d-print-none" HelperText="Edit the JSON structure directly. Ensure all keys and string values are quoted." />
                            }
                        }
                    </MudTabPanel>
                </MudTabs>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>
